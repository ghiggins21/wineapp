{% extends 'base.html' %}
{% load static %}
{% block title %} Wine or Whine {% endblock title %}

{% block scripts %}
  <script>
    $(document).ready(function(){
      $('[data-toggle="tooltip"]').tooltip();
    });
  </script>

    <script type="text/javascript">
      $(document).ready(function(){
          var ctx = document.getElementById('countryChart').getContext('2d');
          var countryChart = new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: [{% for item in country %}'{{item.country__name}}',{% endfor %}],
                  datasets: [{
                      data: [{% for item in country %}'{{item.total}}',{% endfor %}],
                      backgroundColor: [{% for item in country %}getRandomColorHex(),{% endfor %}],
                      borderColor: [{% for item in country %}getRandomColorHex(),{% endfor %}],
                      borderWidth: 1
                  }]
              },
              options: {
                legend: {
                  display: false
                },
                title: {
                  display: true,
                  fontColor: "red",
                  fontFamily: 'Great Vibes',
                  fontStyle: 'normal',
                  fontSize: 60,
                  text: 'Countries',
                  position: 'top'
                },
                  scales: {
                      yAxes: [{
                          ticks: {
                              beginAtZero: true,
                              fontColor: "black",
                              userCallback: function(label, index, labels) {
                                // when the floored value is the same as the value we have a whole number
                                if (Math.floor(label) === label) {
                                  return label;
                                }
                              },
                          }
                      }],
                      xAxes: [{
                          ticks: {
                              fontColor: "black",
                          }
                      }],
                  }
              }
          });

          var ctx = document.getElementById('styleChart').getContext('2d');
          var styleChart = new Chart(ctx, {
              type: 'outlabeledPie',
              labelPosition: 'outside',

              data: {
                  labels: [{% for item in type %}'{{item.type__name}}',{% endfor %}],
                  datasets: [{
                      data: [{% for item in type %}'{{item.total}}',{% endfor %}],
                      backgroundColor: [{% for item in type %}getRandomColorHex(),{% endfor %}],
                      borderColor: [{% for item in type %}getRandomColorHex(),{% endfor %}],
                      borderWidth: 1
                  }]
              },

              options: {
                legend: {
                   display: false,
                 },
                 animation: {
                   animateScale: true,
                   animateRotate: true
                 },
                zoomOutPercentage: 45,
                plugins: {
                  legend: false,
                  outlabels: {
                     text: '%l %p',
                     percentPrecision: 10,
                     color: 'white',
                     stretch: 20,
                     font: {
                         resizable: true,
                         minSize: 8,
                         maxSize: 12
                     }
                  }
               },
                title: {
                  display: true,
                  fontColor: "red",
                  fontFamily: 'Great Vibes',
                  fontStyle: 'normal',
                  fontSize: 60,
                  text: 'Wine Styles',
                  position: 'top'
                },
                responsive: true,

                tooltips: {
                  callbacks: {
                      label: function (tooltipItem, data) {
                        var dataset = data.datasets[tooltipItem.datasetIndex];
                        //calculate the total of this data set
                        var total = dataset.data.reduce(function(previousValue, currentValue) {
                          return parseInt(previousValue) + parseInt(currentValue);
                        });
                        //get the current items value
                        var currentValue = dataset.data[tooltipItem.index];
                        //calculate the precentage based on the total and current item, also this does a rough rounding to give a whole number
                        var percentage = Math.floor(((currentValue/total) * 100)+0.5);
                          return data.labels[tooltipItem.index] + ' (' + percentage + '% )';
                      }
                  }
                },

               legendCallback: function(styleChart) {
                 var text = [];
                 var data = styleChart.data;
                 var datasets = styleChart.data.datasets;
                 var labels = styleChart.data.labels;
                 if (datasets.length) {
                  text.push('<ul style="list-style-type:none; font-size:20px; color:white; font-family: Times New Roman, Times, serif;">');
                    for (var i = 0; i < datasets[0].data.length; ++i) {
                       text.push('<li style="padding-top:10px; padding-bottom:10px; padding-left:10px; height:40px; align-text:center; background-color:' + datasets[0].backgroundColor[i] + '">');
                       if (labels[i]) {
                          // calculate percentage
                          var total = datasets[0].data.reduce(function(previousValue, currentValue, currentIndex, array) {
                             return parseInt(previousValue) + parseInt(currentValue);
                          });

                          var currentValue = datasets[0].data[i];
                          var percentage = Math.floor(((currentValue / total) * 100) + 0.5);

                          text.push(labels[i] + "&nbsp;" + styleChart.data.datasets[0].data[i] + ' (' + percentage + '%)');
                       }
                    }
                 }
                  text.push('</li></span>');
                 text.push('</ul>');

                 return text.join('');
            },

            }
          });

          var ctx = document.getElementById('ratingsChart').getContext('2d');
          var ratingsChart = new Chart(ctx, {
            type: 'horizontalBar',
            data: {
              labels: [{% for item in ratings %}'{{item.rating}} stars',{% endfor %}],
              datasets: [{
                data: [{% for item in ratings %} '{{item.total}}',{% endfor %}],

                //backgroundColor: 'rgba(255,0,0, .3)',
                backgroundColor: [{% for item in ratings %}getRandomColorHex(),{% endfor %}],
                borderColor: [{% for item in ratings %}getRandomColorHex(),{% endfor %}],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              legend: {
                display: false
              },
              title: {
                 display: true,
                 fontColor: "red",
                 fontFamily: 'Great Vibes',
                 fontStyle: 'normal',
                 fontSize: 60,
                 text: 'Star Ratings',
                 position: 'top'
              },
              scales: {
                  yAxes: [{
                    ticks: {
                        fontColor: "black",
                    }
                  }],
                  xAxes: [{
                    ticks: {
                        beginAtZero: true,
                        fontColor: "black",
                        userCallback: function(label, index, labels) {
                        // when the floored value is the same as the value we have a whole number
                        if (Math.floor(label) === label) {
                          return label;
                        }
                      },
                    }
                }],
              },
            }
        });

        var ctx = document.getElementById('grapesChart').getContext('2d');
        var grapesChart = new Chart(ctx, {
          type: 'horizontalBar',
          data: {
            labels: [{% for item in g %}'{{item.grapes__name}}',{% endfor %}],
            datasets: [{
              data: [{% for item in g %} '{{item.total}}',{% endfor %}],

              //backgroundColor: 'rgba(255,0,0, .3)',
              backgroundColor: [{% for item in g %}getRandomColorHex(),{% endfor %}],
              borderColor: [{% for item in g %}getRandomColorHex(),{% endfor %}],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            legend: {
              display: false
            },
            title: {
               display: true,
               fontColor: "red",
               fontFamily: 'Great Vibes',
               fontStyle: 'normal',
               fontSize: 60,
               text: 'Grapes',
               position: 'top'
            },
            scales: {
                yAxes: [{
                  ticks: {
                      fontColor: "black",
                  }
                }],
                xAxes: [{
                  ticks: {
                      beginAtZero: true,
                      fontColor: "black",
                      userCallback: function(label, index, labels) {
                      // when the floored value is the same as the value we have a whole number
                      if (Math.floor(label) === label) {
                        return label;
                      }
                    },
                  }
              }],
            },
          }
      });

        var styleChartLegendContainer = document.getElementById("styleChartLegend");
        styleChartLegendContainer.innerHTML = styleChart.generateLegend();
      });

      function getRandomColorHex() {
        var hex = "0123456789ABCDEF",
        color = "#";
        for (var i = 1; i <= 6; i++) {
          color += hex[Math.floor(Math.random() * 16)];
        }
        return color;
      }

    </script>
{% endblock scripts %}

{% block content %}
{% if user.is_authenticated %}
  <h1 style="margin-top:15px; margin-bottom:25px; text-align:center; font: 500 130px/1.3 'Great Vibes', Helvetica, sans-serif; color:red; font-size:120px; text-shadow: 4px 4px 3px rgba(0,0,0,0.1);">Wine or Whine</h1>
  <div class="container">
    <div class="pt-5 row">
      <div class="col-sm-2" style="padding: 2px">
        <table class="table table-striped text-black">
          <tr>
            <h1 style="margin-top:15px; margin-bottom:15px; text-align:center; font: 300 130px/0.8 'Great Vibes', Helvetica, sans-serif; color:red; font-size:60px; text-shadow: 4px 4px 3px rgba(0,0,0,0.1);"><b>Wines</b></h1>
          </tr>
          <tr>
            <td style="margin-top:15px; margin-bottom:15px; text-align:left; font-family: 'Courgette', cursive; font-size:25px; color:black;">Wines</td>
            <td style="margin-top:15px; margin-bottom:15px; text-align:right; font: 300 130px/0.8, Helvetica, sans-serif; color:black; font-size:25px; text-shadow: 4px 4px 3px rgba(0,0,0,0.1);">{{ wine_count }}</td>
          </tr>
          <tr>
              <td style="margin-top:15px; margin-bottom:15px; text-align:left; font-family: 'Courgette', cursive; font-size:25px; color:black;">Ratings</td>
            <td style="margin-top:15px; margin-bottom:15px; text-align:right; font: 300 130px/0.8, Helvetica, sans-serif; color:black; font-size:25px; text-shadow: 4px 4px 3px rgba(0,0,0,0.1);">{{ wine_ratings }}</td>
          </tr>
          <tr>
              <td style="margin-top:15px; margin-bottom:15px; text-align:left; font-family: 'Courgette', cursive; font-size:25px; color:black;">Cellar</td>
            <td style="margin-top:15px; margin-bottom:15px; text-align:right; font: 300 130px/0.8, Helvetica, sans-serif; color:black; font-size:25px; text-shadow: 4px 4px 3px rgba(0,0,0,0.1);">{{ in_cellar }}</td>
          </tr>
        </table>
      </div>
      <div class="col-sm-10" style="padding: 2px">
        <table class="table table-striped text-black">
          <tr>
            <h1 style="margin-top:15px; margin-bottom:15px; text-align:center; font: 300 130px/0.8 'Great Vibes', Helvetica, sans-serif; color:red; font-size:60px; text-shadow: 4px 4px 3px rgba(0,0,0,0.1);"><b>Latest Rating</b></h1>
          </tr>
          <tr>
            <td rowspan='9' style="text-align: right;">
              {% if last_review.image %}
                  <a href="{% url 'wine_details' id=last_review.id %}"><img src="{{ last_review.image.url }}" width="250" height="350" alt="Logo" width="300px"></a>
              {% else %}
                  <img src={% static 'img/imageless.jpg' %} width="250" height="350" alt="Logo" width="300px">
              {% endif %}
            </td>
            <td><img src={% static 'img/name.png' %} alt="Logo" data-toggle="tooltip" title="Wine Name"></td>
              {% if last_review.name %}
                <td style="font-size:25px;font-family: 'Courgette', cursive;"><a href="{% url 'wine_details' id=last_review.id %}">{{ last_review.name }}</a></td>
              {% endif %}
          </tr>
          <tr>
                {% if last_review.rating == 0 %}
                  <td><img src={% static 'img/rating.png' %} alt="Logo" data-toggle="tooltip" title="Rating"></td>
                {% endif %}
                {% if last_review.rating == 1 %}
                  <td><img src={% static 'img/one.png' %} alt="Logo" data-toggle="tooltip" title="Expired"></td>
                {% endif %}
                {% if last_review.rating == 2 %}
                  <td><img src={% static 'img/two.png' %} alt="Logo" data-toggle="tooltip" title="Awful"></td>
                {% endif %}
                {% if last_review.rating == 3 %}
                  <td><img src={% static 'img/three.png' %} alt="Logo" data-toggle="tooltip" title="Tainted"></td>
                {% endif %}
                {% if last_review.rating == 4 %}
                  <td><img src={% static 'img/four.png' %} alt="Logo" data-toggle="tooltip" title="Poor"></td>
                {% endif %}
                {% if last_review.rating == 5 %}
                  <td><img src={% static 'img/five.png' %} alt="Logo" data-toggle="tooltip" title="Fair"></td>
                {% endif %}
                {% if last_review.rating == 6 %}
                  <td><img src={% static 'img/six.png' %} alt="Logo" data-toggle="tooltip" title="Good"></td>
                {% endif %}
                {% if last_review.rating == 7 %}
                  <td><img src={% static 'img/seven.png' %} alt="Logo" data-toggle="tooltip" title="Very Good"></td>
                {% endif %}
                {% if last_review.rating == 8 %}
                  <td><img src={% static 'img/eight.png' %} alt="Logo" data-toggle="tooltip" title="Excellent"></td>
                {% endif %}
                {% if last_review.rating == 9 %}
                  <td><img src={% static 'img/nine.png' %} alt="Logo" data-toggle="tooltip" title="Fantastic"></td>
                {% endif %}
                {% if last_review.rating == 10 %}
                  <td><img src={% static 'img/ten.png' %} alt="Logo" data-toggle="tooltip" title="Blockbuster"></td>
                {% endif %}
            <td>
              {% for i in range %}
                {% if i < last_review.rating %}
                  <span style="color:red; font-size:30px;">&#10026;</span>
                {% else %}
                  <span style="color:grey; font-size:30px;">&#10026;</span>
                {% endif %}
              {% endfor %}
            </td>
          </tr>
          <tr>
            <td><img src={% static 'img/winery.png' %} alt="Logo" data-toggle="tooltip" title="Winery"></td>
            {% if last_review.winery %}
              <td style="font-size:25px;font-family: 'Courgette', cursive;">{{ last_review.winery }}</td>
            {% endif %}
          </tr>
          <tr>
            <td><img src={% static 'img/calendar.png' %} alt="Logo" data-toggle="tooltip" title="Vintage"></td>
            {% if last_review.vintage %}
               <td style="font-size:25px;font-family: 'Courgette', cursive;">{{ last_review.vintage }}</td>
            {% endif %}
          </tr>
          <tr>
            <td><img src={% static 'img/country.png' %} alt="Logo" data-toggle="tooltip" title="Country"></td>
            {% if last_review.country %}
              <td style="font-size:25px;font-family: 'Courgette', cursive;">{{ last_review.country }}</td>
            {% endif %}
          </tr>
          <tr>
            <td><img src={% static 'img/info.png' %} alt="Logo" data-toggle="tooltip" title="abv"></td>
            {% if last_review.abv %}
              <td style="font-size:25px;font-family: 'Courgette', cursive;">{{ last_review.abv }}% abv</td>
            {% endif %}
          </tr>
          <tr>
            {% if type_name == 'Carcavelos' %}
              <td><img src={% static 'img/fortified.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Champagne' %}
              <td><img src={% static 'img/champagne.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Coteaux Champenois' %}
              <td><img src={% static 'img/champagne.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Crémant' %}
              <td><img src={% static 'img/sparkling.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Crémant Rosé' %}
              <td><img src={% static 'img/sparkling.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Dessert' %}
              <td><img src={% static 'img/dessert.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Dessert Red' %}
              <td><img src={% static 'img/dessert.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Fortified' %}
              <td><img src={% static 'img/fortified.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Madeira' %}
              <td><img src={% static 'img/fortified.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Orange' %}
              <td><img src={% static 'img/orange.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Port' %}
              <td><img src={% static 'img/fortified.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Red' %}
              <td><img src={% static 'img/red.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Rosé' %}
              <td><img src={% static 'img/rose.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Rosé Champagne' %}
              <td><img src={% static 'img/champagne.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Sherry' %}
              <td><img src={% static 'img/fortified.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Sparkling' %}
              <td><img src={% static 'img/sparkling.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Sparkling Red' %}
              <td><img src={% static 'img/sparkling.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'Sparkling Rosé' %}
              <td><img src={% static 'img/sparkling.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'White' %}
              <td><img src={% static 'img/white.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            {% if type_name == 'White Port' %}
              <td><img src={% static 'img/foritfied.png' %} alt="Logo" data-toggle="tooltip" title="Style"></td>
            {% endif %}
            <td style="font-size:25px;font-family: 'Courgette', cursive;">{{ last_review.type }}</td>
          </tr>
          <tr>
            <td><img src={% static 'img/grapes.png' %} alt="Logo" data-toggle="tooltip" title="Grapes"></td>
            <td style="font-size:25px;font-family: 'Courgette', cursive;">
              {% if grapes %}
                {% for grape in grapes %}
                  {% if not forloop.last %}
                    {{ grape.name }},
                 {% else %}
                  {{ grape.name }}
                {% endif %}
              {% endfor %}
            {% endif %}
            </td>
          </tr>
          <tr>
            <td><img src={% static 'img/posted_on.png' %} alt="Logo" data-toggle="tooltip" title="Posted on"></td>
            {% if last_review.posted_on %}
              <td style="font-size:25px;font-family: 'Courgette', cursive;">{{ last_review.posted_on }}</td>
            {% endif %}
          </tr>
        </table>
      </div>

    </div>
    <div class="pt-5 row">
      <div class="col-sm-12">
        <canvas id="countryChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div class="pt-5 row ">
      <div class="col-sm-8 align-left">
        <canvas id="styleChart" width="400" height="500"></canvas>
      </div>
      <div class="col-sm-4 align-right">
        <div id="styleChartLegend" style="margin:0 auto; padding-top: 100px;"></div>
      </div>
    </div>

    <div class="pt-5 row">
      <div class="col-sm-12 align-left">
        <canvas id="ratingsChart" width="400" height="200"></canvas>
      </div>
    </div>

    <div class="pt-5 row">
      <div class="col-sm-12 align-left">
        <canvas id="grapesChart" width="400" height="1200"></canvas>
      </div>
    </div>
  </div>
{% else %}

<div class="form-row" style="padding-top: 50px; padding-bottom: 20px;">
  <div class="form-group col-md-4 mb-0">
    <p style="font-size:30px;font-family: 'Times New Roman', Times, serif;"><b>You are not logged in</b></p>
    <a href="{% url 'login' %}"><button type="submit" class="btn btn-primary">Login</button></a>
  </div>
</div>

{% endif %}
{% endblock %}
